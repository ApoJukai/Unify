<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PlanTask | Plant Your Tasks</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;800&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #7B61FF; --primary-dark: #5A3EBA; --accent: #4CAF50;
            --bg-main: #EDE7F6; --bg-card: #ffffff; --text-main: #333333;
            --text-light: #FFFFFF; --text-muted: #6b7280; --border: #e2e8f0;
            --today-line: #ff4444;
            --p-high: #ff4444; --p-med: #ffb300; --p-low: #94a3b8;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: var(--bg-main); color: var(--text-main); font-family: 'Lato', sans-serif; display: flex; height: 100vh; overflow: hidden; }

        /* Sidebar */
        aside { width: 280px; background: var(--primary-dark); padding: 30px 20px; display: flex; flex-direction: column; color: var(--text-light); flex-shrink: 0; }
        .logo-container { display: flex; align-items: center; gap: 12px; margin-bottom: 35px; font-family: 'Montserrat', sans-serif; font-weight: 800; font-size: 24px; }
        .logo-icon-wrapper { position: relative; display: flex; align-items: center; }
        .leaf-icon { position: absolute; top: -8px; right: -5px; color: var(--accent); transform: rotate(15deg); }
        
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 14px 18px; border-radius: 12px; cursor: pointer; margin-bottom: 8px; font-weight: 700; color: rgba(255,255,255,0.7); transition: 0.3s; }
        .nav-item.active { background: var(--primary); color: #fff; }
        
        .create-btn { width: 100%; background: var(--accent); color: #fff; border: none; padding: 16px; border-radius: 12px; font-weight: 800; font-family: 'Montserrat'; cursor: pointer; margin-bottom: 25px; }

        .sidebar-footer { margin-top: auto; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); display: flex; flex-direction: column; gap: 10px; }
        .data-btn { flex: 1; background: rgba(255,255,255,0.1); color: #fff; border: 1px solid rgba(255,255,255,0.2); padding: 10px; border-radius: 8px; font-size: 11px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .github-input { width: 100%; background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); padding: 10px; border-radius: 8px; color: white; font-size: 11px; outline: none; }

        /* Main */
        main { flex: 1; display: flex; flex-direction: column; overflow: hidden; background: #fff; border-radius: 30px 0 0 30px; margin: 10px 0; box-shadow: -10px 0 30px rgba(0,0,0,0.05); }
        header { padding: 25px 40px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #f0f0f0; }
        .view-section { display: none; padding: 30px 40px; overflow-y: auto; height: 100%; }

        /* Board */
        .kanban-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        .kanban-col { background: #f8f9fa; padding: 20px; border-radius: 24px; min-height: 60vh; }
        .task-card { background: #fff; padding: 18px; border-radius: 16px; margin-bottom: 15px; cursor: grab; border-left: 5px solid var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        /* List Table */
        .list-table { width: 100%; border-collapse: separate; border-spacing: 0 10px; table-layout: fixed; }
        .list-table th { text-align: left; padding: 10px 20px; font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }
        .list-row td { background: #fcfaff; padding: 15px 20px; border-top: 1px solid var(--border); border-bottom: 1px solid var(--border); vertical-align: middle; }
        .desc-truncate { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; font-size: 12px; color: var(--text-muted); }
        .list-row td:first-child { border-left: 1px solid var(--border); border-radius: 15px 0 0 15px; width: 40%; }
        .list-row td:last-child { border-right: 1px solid var(--border); border-radius: 0 15px 15px 0; width: 120px; }

        /* Priority Dot & Animation */
        .priority-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 12px; transition: transform 0.3s ease; }
        .pulse-high { animation: dot-pulse 1.5s infinite; }
        @keyframes dot-pulse {
            0% { box-shadow: 0 0 0 0px rgba(255, 68, 68, 0.4); }
            70% { box-shadow: 0 0 0 6px rgba(255, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0px rgba(255, 68, 68, 0); }
        }

        /* Drag & Drop Visuals */
        .list-row[draggable="true"] { cursor: grab; }
        .list-row.dragging { opacity: 0.4; background: #f0ebff; }
        .list-row.drag-over { border-top: 2px solid var(--primary); }

        /* Timeline Specifics */
        .timeline-container { display: flex; border: 1px solid var(--border); border-radius: 20px; overflow: hidden; height: 65vh; background: #fff; }
        .t-sidebar { width: 350px; border-right: 1px solid var(--border); background: #fbfaff; display: flex; flex-direction: column; flex-shrink: 0; }
        .t-sidebar-header { display: flex; border-bottom: 1px solid var(--border); background: #f3f0ff; height: 46px; align-items: center; }
        .t-column-title { padding: 0 15px; font-size: 10px; font-weight: 800; color: var(--primary-dark); text-transform: uppercase; }
        
        .t-grid { flex: 1; overflow-x: auto; position: relative; scroll-behavior: smooth; }
        .t-day { width: 80px; flex-shrink: 0; border-right: 1px solid #eee; text-align: center; font-size: 10px; padding: 15px 0; font-weight: 700; color: var(--text-muted); }
        .t-bar { position: absolute; height: 32px; border-radius: 16px; color: white; font-size: 10px; font-weight: 700; display: flex; align-items: center; padding: 0 12px; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; z-index: 5; transition: transform 0.2s; }
        .t-bar:hover { transform: scale(1.02); filter: brightness(1.1); }

        .t-side-row { display: flex; height: 50px; border-bottom: 1px solid var(--border); align-items: center; }
        .t-side-cell { padding: 0 15px; font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .today-line { position: absolute; top: 0; bottom: 0; width: 2px; background: var(--today-line); z-index: 10; pointer-events: none; }
        .today-marker { position: absolute; top: 0; left: -4px; width: 10px; height: 10px; background: var(--today-line); border-radius: 50%; }

        /* Modal */
        .modal { display: none; position: fixed; inset: 0; background: rgba(90, 62, 186, 0.4); backdrop-filter: blur(5px); z-index: 1000; align-items: center; justify-content: center; }
        .modal-card { background: #fff; width: 1000px; border-radius: 30px; display: grid; grid-template-columns: 1fr 380px; height: 85vh; overflow: hidden; }
        .chat-container { flex: 1; overflow-y: auto; padding: 15px; background: #f3f0ff; border-radius: 15px; display: flex; flex-direction: column; gap: 10px; margin-bottom: 10px; }
        .sms-bubble { max-width: 85%; padding: 10px 14px; border-radius: 18px; font-size: 12px; background: #fff; align-self: flex-start; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .sms-mine { align-self: flex-end; background: var(--primary); color: white; }
        .pill { padding: 4px 10px; border-radius: 20px; font-size: 10px; font-weight: 800; display: inline-block; }
        .pill-todo { background: #e2e8f0; color: #475569; }
        .pill-progress { background: #fff7ed; color: #c2410c; }
        .pill-done { background: #f0fdf4; color: #15803d; }
    </style>
</head>
<body onmousedown="checkClose(event)">

    <aside>
        <div class="logo-container">
            <div class="logo-icon-wrapper"><i data-lucide="menu" size="32"></i><i data-lucide="leaf" size="16" class="leaf-icon"></i></div>
            <span>PlanTask</span>
        </div>
        <button class="create-btn" onclick="openModal()">+ New Task</button>
        <nav>
            <div class="nav-item active" onclick="switchView('board', this)"><i data-lucide="layout-dashboard"></i> Kanban Board</div>
            <div class="nav-item" onclick="switchView('list', this)"><i data-lucide="layers"></i> Task List</div>
            <div class="nav-item" onclick="switchView('timeline', this)"><i data-lucide="milestone"></i> Timeline</div>
            <div class="nav-item" onclick="switchView('analytics', this)"><i data-lucide="pie-chart"></i> Growth Stats</div>
            <div class="nav-item" onclick="switchView('archive', this)"><i data-lucide="archive-restore"></i> Harvested</div>
        </nav>
        <div class="sidebar-footer">
            <input type="password" id="ghToken" class="github-input" placeholder="GitHub Token (for Sync)">
            <div style="display: flex; gap: 8px;">
                <input type="file" id="importFile" style="display: none;" onchange="importTasks(event)" accept=".json">
                <button class="data-btn" onclick="document.getElementById('importFile').click()"><i data-lucide="file-up"></i> Import</button>
                <button class="data-btn" onclick="exportTasks()"><i data-lucide="file-down"></i> Export</button>
            </div>
        </div>
    </aside>

    <main>
        <header>
            <h1 id="view-title">Kanban Board</h1>
            <div style="position: relative; width: 300px;">
                <i data-lucide="search" style="position: absolute; left: 12px; top: 10px; color: var(--text-muted); width: 18px;"></i>
                <input type="text" id="globalSearch" placeholder="Find a task..." oninput="renderActive()" style="width:100%; padding: 10px 15px 10px 40px; border-radius: 12px; border: 1px solid var(--border); outline: none;">
            </div>
        </header>

        <div id="view-board" class="view-section" style="display: block;">
            <div class="kanban-grid">
                <div id="Not Started" class="kanban-col" ondrop="drop(event)" ondragover="allow(event)">
                    <p style="font-weight: 800; font-size: 11px; color: var(--text-muted); margin-bottom: 20px;">PLANTING</p>
                    <div id="board-notstarted"></div>
                </div>
                <div id="In-Progress" class="kanban-col" ondrop="drop(event)" ondragover="allow(event)">
                    <p style="font-weight: 800; font-size: 11px; color: var(--primary); margin-bottom: 20px;">GROWING</p>
                    <div id="board-inprogress"></div>
                </div>
                <div id="Finished" class="kanban-col" ondrop="drop(event)" ondragover="allow(event)">
                    <p style="font-weight: 800; font-size: 11px; color: var(--accent); margin-bottom: 20px;">BLOOMED</p>
                    <div id="board-finished"></div>
                </div>
            </div>
        </div>

        <div id="view-list" class="view-section">
            <div class="list-controls" style="display: flex; gap: 15px; margin-bottom: 20px; align-items: center;">
                <button onclick="toggleDateSort()" class="data-btn" style="background: white; color: var(--text-main); border: 1px solid var(--border); width: auto; padding: 10px 15px; min-width: 180px;">
                    <i data-lucide="calendar" size="14"></i> Sort: <span id="sortDirText">Manual</span>
                </button>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <span style="font-size: 12px; font-weight: 700; color: var(--text-muted);">PRIORITY:</span>
                    <select id="priorityFilter" onchange="renderActive()" style="padding: 10px; border-radius: 8px; border: 1px solid var(--border); font-family: 'Lato'; outline: none;">
                        <option value="All">All Plants</option>
                        <option value="High">High Priority</option>
                        <option value="Medium">Medium Priority</option>
                        <option value="Low">Low Priority</option>
                    </select>
                </div>
            </div>
            <table class="list-table">
                <thead><tr><th>Goal & Vision</th><th>Owner</th><th>Timeline</th><th>Status</th><th style="text-align:right">Action</th></tr></thead>
                <tbody id="list-tbody"></tbody>
            </table>
        </div>

        <div id="view-timeline" class="view-section">
            <div class="timeline-container">
                <div class="t-sidebar">
                    <div class="t-sidebar-header">
                        <div class="t-column-title" style="flex: 2;">Task Name</div>
                        <div class="t-column-title" style="flex: 1; border-left: 1px solid var(--border);">Owner</div>
                    </div>
                    <div id="t-side-items"></div>
                </div>
                <div class="t-grid" id="t-scroll-box">
                    <div style="display: flex; border-bottom: 1px solid var(--border); background: #fff;" id="t-headers"></div>
                    <div id="t-bars-container" style="position:relative; min-height:100%">
                        </div>
                </div>
            </div>
        </div>

        <div id="view-analytics" class="view-section">
            <div id="insight-box" style="display:grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px;"></div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 25px;">
                <div style="height:350px; padding:25px; border:1px solid var(--border); border-radius:24px"><canvas id="c-status"></canvas></div>
                <div style="height:350px; padding:25px; border:1px solid var(--border); border-radius:24px"><canvas id="c-priority"></canvas></div>
            </div>
        </div>

        <div id="view-archive" class="view-section">
            <table class="list-table">
                <thead><tr><th>Harvested Task</th><th>Owner</th><th>Timeline</th><th>Status</th><th style="text-align:right">Action</th></tr></thead>
                <tbody id="archive-tbody"></tbody>
            </table>
        </div>
    </main>

    <div class="modal" id="taskModal">
        <div class="modal-card">
            <div style="padding:40px; overflow-y:auto">
                <h2 style="font-family:'Montserrat'; margin-bottom:25px; color:var(--primary-dark)">Task Editor</h2>
                <form id="taskForm">
                    <input type="hidden" id="editId">
                    <input type="text" id="mName" placeholder="Task Name" style="width:100%; padding:15px; border-radius:12px; border:1px solid var(--border); margin-bottom:15px; font-weight:700" required>
                    <textarea id="mDesc" placeholder="Describe your vision..." style="width:100%; padding:15px; border-radius:12px; border:1px solid var(--border); height:120px; margin-bottom:15px; resize:none"></textarea>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:15px">
                        <label style="font-size:10px; color:var(--text-muted); font-weight:700">START DATE
                            <input type="date" id="mStart" style="width:100%; padding:12px; border-radius:12px; border:1px solid var(--border); margin-top:5px">
                        </label>
                        <label style="font-size:10px; color:var(--text-muted); font-weight:700">END DATE
                            <input type="date" id="mEnd" style="width:100%; padding:12px; border-radius:12px; border:1px solid var(--border); margin-top:5px">
                        </label>
                    </div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:30px">
                        <input type="text" id="mOwner" placeholder="Owner" style="padding:12px; border-radius:12px; border:1px solid var(--border)">
                        <select id="mImp" style="padding:12px; border-radius:12px; border:1px solid var(--border)">
                            <option>High</option><option selected>Medium</option><option>Low</option>
                        </select>
                    </div>
                    <select id="mStat" style="width:100%; padding:15px; border-radius:12px; border:1px solid var(--border); margin-bottom:25px; font-weight:700">
                        <option>Not Started</option><option>In-Progress</option><option>Finished</option>
                    </select>
                    <div style="display:flex; gap:10px">
                        <button type="button" onclick="closeModal()" style="flex:1; padding:15px; border-radius:12px; border:none; cursor:pointer">Cancel</button>
                        <button type="submit" style="flex:2; background:var(--primary); color:#fff; padding:15px; border-radius:12px; border:none; font-weight:800; cursor:pointer">Save Task</button>
                    </div>
                </form>
            </div>
            <div style="background:#f9f8ff; padding:30px; border-left:1px solid #eee; display:flex; flex-direction:column">
                <h4 style="font-size:11px; letter-spacing:1px; color:var(--text-muted); margin-bottom:15px; font-weight:800">Task Notes</h4>
                <div id="chatContainer" class="chat-container"></div>
                <div style="display:flex; gap:8px; margin-bottom:20px">
                    <input type="text" id="chatInput" placeholder="Write a note..." style="flex:1; padding:10px 15px; border-radius:20px; border:1px solid var(--border); font-size:12px" onkeypress="if(event.key==='Enter') addComment()">
                    <button onclick="addComment()" style="background:var(--primary); color:white; border:none; width:35px; height:35px; border-radius:50%; cursor:pointer">+</button>
                </div>
                <h4 style="font-size:11px; letter-spacing:1px; color:var(--text-muted); margin-bottom:10px; font-weight:800">SYSTEM LOG</h4>
                <div id="activityLog" style="flex:0.5; font-size:10px; color:var(--text-muted); overflow-y:auto"></div>
            </div>
        </div>
    </div>

    <script>
        let tasks = JSON.parse(localStorage.getItem('PlanTask_V1')) || [];
        let charts = {};
        let tempComments = [];
        let dateSortDir = 'none'; 
        let draggedIdx = null;

        // NEW: Updated Save Logic with GitHub Sync
        async function save() { 
            localStorage.setItem('PlanTask_V1', JSON.stringify(tasks)); 
            renderActive(); 

            const token = "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";
            if (token) {
                try {
                    await saveToGithub(token, tasks);
                } catch (err) {
                    console.error("Sync Error:", err);
                }
            }
        }

        async function saveToGithub(token, tasksData) {
            const OWNER = 'ApoJukai';
            const REPO = 'Unify';
            const PATH = 'tasks.json';
            const URL = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${PATH}`;

            try {
                // 1. Get the current file to get its SHA (required for updates)
                const getFile = await fetch(URL, {
                    headers: { 'Authorization': `token ${token}` }
                });
                
                let sha = null;
                if (getFile.ok) {
                    const fileData = await getFile.json();
                    sha = fileData.sha;
                }

                // 2. Update the file
                const response = await fetch(URL, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: "Update tasks via PlanTask UI",
                        content: btoa(unescape(encodeURIComponent(JSON.stringify(tasksData, null, 2)))), 
                        sha: sha
                    })
                });

                if (response.ok) {
                    console.log("Synced to GitHub successfully!");
                } else {
                    const errorDetails = await response.json();
                    console.warn("GitHub Sync Issue:", errorDetails.message);
                }
            } catch (e) {
                console.error("Network Error during GitHub Sync", e);
            }
        }

        function getFiltered() {
            const q = document.getElementById('globalSearch').value.toLowerCase();
            return tasks.filter(t => t.name.toLowerCase().includes(q) || (t.owner && t.owner.toLowerCase().includes(q)));
        }

        function getProcessedTasks() {
            let filtered = getFiltered();
            const pFilter = document.getElementById('priorityFilter').value;
            if (pFilter !== 'All') {
                filtered = filtered.filter(t => t.importance === pFilter);
            }
            if (dateSortDir !== 'none') {
                filtered.sort((a, b) => {
                    const dateA = a.end ? new Date(a.end) : new Date('9999-12-31');
                    const dateB = b.end ? new Date(b.end) : new Date('9999-12-31');
                    return dateSortDir === 'asc' ? dateA - dateB : dateB - dateA;
                });
            }
            return filtered;
        }

        function toggleDateSort() {
            if (dateSortDir === 'none') dateSortDir = 'asc';
            else if (dateSortDir === 'asc') dateSortDir = 'desc';
            else dateSortDir = 'none';
            document.getElementById('sortDirText').innerText = dateSortDir === 'none' ? 'Manual' : dateSortDir.toUpperCase();
            renderActive();
        }

        function switchView(v, el) {
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            el.classList.add('active');
            document.querySelectorAll('.view-section').forEach(s => s.style.display = 'none');
            document.getElementById('view-' + v).style.display = 'block';
            document.getElementById('view-title').innerText = el.innerText;
            renderActive();
        }

        function allow(e) { e.preventDefault(); }
        function drag(e, id) { e.dataTransfer.setData("text", id); }
        function drop(e) {
            e.preventDefault();
            const id = e.dataTransfer.getData("text");
            const newStatus = e.currentTarget.id;
            tasks = tasks.map(t => t.id == id ? {...t, status: newStatus, logs: [`Moved to ${newStatus} (${new Date().toLocaleTimeString()})`, ...(t.logs||[])]} : t);
            save();
        }

        function dragList(e, id) {
            if (dateSortDir !== 'none') return;
            draggedIdx = tasks.findIndex(t => t.id == id);
            e.dataTransfer.effectAllowed = "move";
            e.target.classList.add('dragging');
        }

        function allowList(e) {
            e.preventDefault();
            const row = e.target.closest('.list-row');
            if (row && dateSortDir === 'none') row.classList.add('drag-over');
        }

        function leaveList(e) {
            const row = e.target.closest('.list-row');
            if (row) row.classList.remove('drag-over');
        }

        function dropList(e, targetId) {
            e.preventDefault();
            const row = e.target.closest('.list-row');
            if (row) row.classList.remove('drag-over');
            if (dateSortDir !== 'none') return;
            const targetIdx = tasks.findIndex(t => t.id == targetId);
            if (draggedIdx !== null && targetIdx !== -1) {
                const [movedItem] = tasks.splice(draggedIdx, 1);
                tasks.splice(targetIdx, 0, movedItem);
                save();
            }
            draggedIdx = null;
        }

        function renderBoard() {
            const cols = {'Not Started': 'board-notstarted', 'In-Progress': 'board-inprogress', 'Finished': 'board-finished'};
            Object.values(cols).forEach(c => { if (document.getElementById(c)) document.getElementById(c).innerHTML = ''; });
            getFiltered().filter(t => !t.archived).forEach(t => {
                const color = t.importance === 'High' ? 'var(--accent)' : 'var(--primary)';
                const colId = cols[t.status];
                if (document.getElementById(colId)) {
                    document.getElementById(colId).innerHTML += `
                        <div class="task-card" draggable="true" ondragstart="drag(event, ${t.id})" onclick="openModal(${t.id})" style="border-left-color:${color}">
                            <div style="font-weight:800; font-size:13px">${t.name}</div>
                            <div style="font-size:10px; color:var(--text-muted); margin-top:5px">${t.owner || 'Unassigned'}</div>
                        </div>`;
                }
            });
        }

        function renderList() {
            const processed = getProcessedTasks();
            const getRow = (t) => {
                const sPill = t.status === 'Finished' ? 'pill-done' : (t.status === 'In-Progress' ? 'pill-progress' : 'pill-todo');
                const dotColor = t.importance === 'High' ? 'var(--p-high)' : (t.importance === 'Medium' ? 'var(--p-med)' : 'var(--p-low)');
                const isHigh = t.importance === 'High' ? 'pulse-high' : '';
                
                let scale = 1;
                if(t.end && t.status !== 'Finished') {
                    const diff = (new Date(t.end) - new Date()) / (1000 * 60 * 60 * 24);
                    if(diff <= 0) scale = 1.8; 
                    else if(diff <= 3) scale = 1.5; 
                    else if(diff <= 7) scale = 1.2; 
                }

                return `<tr class="list-row" 
                            draggable="${dateSortDir === 'none'}" 
                            ondragstart="dragList(event, ${t.id})" 
                            ondragover="allowList(event)" 
                            ondragleave="leaveList(event)"
                            ondrop="dropList(event, ${t.id})">
                    <td>
                        <div style="display:flex; align-items:center; font-weight:700; margin-bottom:4px">
                            <span class="priority-dot ${isHigh}" style="background:${dotColor}; transform: scale(${scale})"></span>
                            ${t.name}
                        </div>
                        <div class="desc-truncate">${t.desc || 'No vision details shared...'}</div>
                    </td>
                    <td><div style="font-size:13px; font-weight:700">${t.owner || '-'}</div></td>
                    <td><div style="font-size:11px; color:var(--text-muted)">${t.start ? t.start : '...'} → ${t.end ? t.end : '...'}</div></td>
                    <td><span class="pill ${sPill}">${t.status}</span></td>
                    <td style="text-align:right">
                        <div style="display:flex; gap:10px; justify-content:flex-end">
                            <button onclick="openModal(${t.id})" style="border:none; background:none; cursor:pointer; color:var(--primary)"><i data-lucide="edit-3" size="16"></i></button>
                            ${!t.archived && t.status === 'Finished' ? `<button onclick="toggleArchive(${t.id}, true)" style="border:none; background:none; cursor:pointer; color:var(--accent)"><i data-lucide="package" size="16"></i></button>` : ''}
                            ${t.archived ? `<button onclick="toggleArchive(${t.id}, false)" style="border:none; background:none; cursor:pointer; color:var(--primary)"><i data-lucide="refresh-cw" size="16"></i></button>` : ''}
                            <button onclick="deleteTask(${t.id})" style="border:none; background:none; cursor:pointer; color:#ff4444"><i data-lucide="trash-2" size="16"></i></button>
                        </div>
                    </td>
                </tr>`;
            };
            document.getElementById('list-tbody').innerHTML = processed.filter(t => !t.archived).map(getRow).join('');
            document.getElementById('archive-tbody').innerHTML = processed.filter(t => t.archived).map(getRow).join('');
            lucide.createIcons();
        }

        function renderTimeline() {
            const side = document.getElementById('t-side-items');
            const head = document.getElementById('t-headers');
            const bars = document.getElementById('t-bars-container');
            const filtered = getFiltered().filter(t => !t.archived && t.start && t.end);
            side.innerHTML = ''; head.innerHTML = ''; bars.innerHTML = '';
            const dayWidth = 80; const rowHeight = 50;
            const viewStart = new Date(); viewStart.setHours(0,0,0,0); viewStart.setDate(viewStart.getDate() - 5);
            for(let i=0; i<30; i++) {
                const d = new Date(viewStart); d.setDate(d.getDate() + i);
                const isToday = new Date().toDateString() === d.toDateString();
                head.innerHTML += `<div class="t-day" style="${isToday ? 'background: #f0f7ff; color: var(--primary);' : ''}">${d.toLocaleDateString([], {month:'short', day:'numeric'})}</div>`;
            }
            const now = new Date(); const todayDiff = (now - viewStart) / (1000 * 60 * 60 * 24);
            const todayPos = todayDiff * dayWidth;
            bars.innerHTML += `<div class="today-line" style="left: ${todayPos}px;"><div class="today-marker"></div></div>`;
            filtered.forEach((t, i) => {
                const tStart = new Date(t.start); tStart.setHours(0,0,0,0);
                const tEnd = new Date(t.end); tEnd.setHours(0,0,0,0);
                const offsetDays = (tStart - viewStart) / (1000 * 60 * 60 * 24);
                const durationDays = ((tEnd - tStart) / (1000 * 60 * 60 * 24)) + 1;
                if (offsetDays + durationDays > 0 && offsetDays < 30) {
                    const leftPos = offsetDays * dayWidth; const barWidth = durationDays * dayWidth;
                    const statusColor = t.status === 'Finished' ? 'var(--accent)' : 'var(--primary)';
                    bars.innerHTML += `<div class="t-bar" onclick="openModal(${t.id})" style="top:${i * rowHeight + 9}px; left:${leftPos}px; width:${barWidth}px; background:${statusColor}">${t.name}</div>`;
                }
                side.innerHTML += `<div class="t-side-row"><div class="t-side-cell" style="flex: 2; font-weight: 700;">${t.name}</div><div class="t-side-cell" style="flex: 1; border-left: 1px solid var(--border); color: var(--text-muted); font-size: 11px;">${t.owner || '-'}</div></div>`;
            });
        }

        function renderAnalytics() {
            const f = getFiltered();
            const total = f.length; const done = f.filter(t => t.status === 'Finished').length;
            const active = f.filter(t => t.status === 'In-Progress').length;
            document.getElementById('insight-box').innerHTML = `
                <div style="background:var(--primary); color:white; padding:20px; border-radius:20px"><h4>Total Tasks</h4><h2 style="font-size:28px">${total}</h2></div>
                <div style="background:white; border:1px solid var(--border); padding:20px; border-radius:20px"><h4>Bloomed</h4><h2 style="font-size:28px">${done}</h2></div>
                <div style="background:white; border:1px solid var(--border); padding:20px; border-radius:20px"><h4>Growth Rate</h4><h2 style="font-size:28px">${total?Math.round(done/total*100):0}%</h2></div>
                <div style="background:var(--accent); color:white; padding:20px; border-radius:20px"><h4>Active Task</h4><h2 style="font-size:28px">${active}</h2></div>
            `;
            if(charts.s) charts.s.destroy();
            charts.s = new Chart(document.getElementById('c-status'), {
                type: 'doughnut', data: { labels: ['To Do', 'Active', 'Done'], datasets: [{ data: [f.filter(t=>t.status==='Not Started').length, active, done], backgroundColor: ['#e2e8f0', '#7B61FF', '#4CAF50'] }] },
                options: { maintainAspectRatio: false }
            });
            if(charts.p) charts.p.destroy();
            charts.p = new Chart(document.getElementById('c-priority'), {
                type: 'bar', data: { labels: ['High', 'Medium', 'Low'], datasets: [{ label: 'Priority', data: ['High','Medium','Low'].map(p=>f.filter(t=>t.importance===p).length), backgroundColor: '#7B61FF' }] },
                options: { maintainAspectRatio: false }
            });
        }

        function openModal(id = null) {
            document.getElementById('taskForm').reset();
            document.getElementById('editId').value = id || '';
            tempComments = [];
            const t = tasks.find(x => x.id == id);
            if(t) {
                document.getElementById('mName').value = t.name;
                document.getElementById('mDesc').value = t.desc || '';
                document.getElementById('mStart').value = t.start || '';
                document.getElementById('mEnd').value = t.end || '';
                document.getElementById('mOwner').value = t.owner || '';
                document.getElementById('mImp').value = t.importance;
                document.getElementById('mStat').value = t.status;
                document.getElementById('chatContainer').innerHTML = (t.comments || []).map(c => `<div class="sms-bubble ${c.mine?'sms-mine':''}">${c.text}</div>`).join('');
                document.getElementById('activityLog').innerHTML = (t.logs || []).map(l => `<div>• ${l}</div>`).join('');
            } else {
                document.getElementById('chatContainer').innerHTML = '';
                document.getElementById('activityLog').innerHTML = '';
            }
            document.getElementById('taskModal').style.display = 'flex';
            lucide.createIcons();
        }

        function addComment() {
            const input = document.getElementById('chatInput'); if(!input.value) return;
            const id = document.getElementById('editId').value;
            const msg = { text: input.value, mine: true };
            if(id) {
                const t = tasks.find(x => x.id == id);
                t.comments = t.comments || []; t.comments.push(msg);
                save(); openModal(id);
            } else {
                tempComments.push(msg);
                document.getElementById('chatContainer').innerHTML += `<div class="sms-bubble sms-mine">${msg.text}</div>`;
            }
            input.value = '';
        }

        document.getElementById('taskForm').onsubmit = (e) => {
            e.preventDefault();
            const id = document.getElementById('editId').value;
            const existing = tasks.find(t => t.id == id);
            const obj = {
                id: id ? parseInt(id) : Date.now(),
                name: document.getElementById('mName').value,
                desc: document.getElementById('mDesc').value,
                start: document.getElementById('mStart').value,
                end: document.getElementById('mEnd').value,
                owner: document.getElementById('mOwner').value,
                importance: document.getElementById('mImp').value,
                status: document.getElementById('mStat').value,
                archived: false,
                logs: existing ? existing.logs : [`Created task (${new Date().toLocaleTimeString()})`],
                comments: existing ? existing.comments : tempComments
            };
            if(id) tasks = tasks.map(t => t.id == id ? {...t, ...obj} : t);
            else tasks.push(obj);
            save(); closeModal();
        };

        function toggleArchive(id, state) { tasks = tasks.map(t => t.id == id ? {...t, archived: state} : t); save(); }
        function deleteTask(id) { if(confirm("Delete this task?")) { tasks = tasks.filter(t => t.id != id); save(); } }
        function closeModal() { document.getElementById('taskModal').style.display = 'none'; }
        function checkClose(e) { if(e.target.id === 'taskModal') closeModal(); }
        
        function exportTasks() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(tasks, null, 2));
            const dl = document.createElement('a'); dl.setAttribute("href", dataStr); dl.setAttribute("download", "PlanTask_backup.json"); dl.click();
        }
        function importTasks(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (ev) => { tasks = JSON.parse(ev.target.result); save(); };
            reader.readAsText(file);
        }

        function renderActive() { renderBoard(); renderList(); renderTimeline(); renderAnalytics(); lucide.createIcons(); }
        renderActive();
    </script>
</body>
</html>

